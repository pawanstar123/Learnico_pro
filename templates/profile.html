{% extends 'app.html' %}
{% block title %}Profile - Learnico{% endblock %}
{% block content %}

<div class="auth-card profile-wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert {{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if user %}
    <!-- Hero banner with rank and XP -->
    <div class="profile-hero">
        <div class="cover">
            <div class="profile-header-text">
                <h2 class="profile-title">Profile</h2>
                <p class="profile-subtitle">View and update your player details</p>
            </div>
        </div>
        <div class="hero-content">
            {% set elo = user[4] if user[4] else 1000 %}
            {% if elo >= 1500 %}
            <div class="rank-badge rank-gold" title="Current Rank">Gold</div>
            {% elif elo >= 1200 %}
            <div class="rank-badge rank-silver" title="Current Rank">Silver</div>
            {% else %}
            <div class="rank-badge rank-bronze" title="Current Rank">Bronze</div>
            {% endif %}
            <div class="hero-main">
                <div class="hero-name">{{ user[1] }}</div>
                <div class="hero-id">ID: {{ user[0] }} | Rating: {{ elo }}</div>
            </div>
            <div class="xp">
                <div class="xp-top">
                    <span>XP</span>
                    {% set current_xp = user[7] if user[7] else 0 %}
                    {% set next_level_xp = ((current_xp // 1000) + 1) * 1000 %}
                    {% set xp_progress = ((current_xp % 1000) / 1000 * 100) | int %}
                    <span class="xp-value">{{ current_xp }} / {{ next_level_xp }}</span>
                </div>
                <div class="xp-bar"><span class="xp-progress" data-progress="{{ xp_progress }}"></span></div>
            </div>
        </div>
    </div>

    <div class="profile-grid">
        <!-- Left: Avatar + Actions -->
        <div class="profile-left">
            <div class="avatar-ring">
                <img src="{{ url_for('static', filename=avatar_filename) if avatar_filename else 'https://via.placeholder.com/160?text=üôÇ' }}"
                    alt="Avatar">
            </div>
            <div class="gallery-icon-container">
                <button class="gallery-icon" onclick="document.getElementById('avatar-input').click()">
                    <i class="gallery-icon-symbol">üñºÔ∏è</i>
                </button>
            </div>
            <form action="/profile" method="POST" enctype="multipart/form-data" class="profile-upload"
                style="display: none;">
                <input type="hidden" name="name" value="{{ user[1] }}">
                <input type="file" id="avatar-input" name="avatar" accept="image/*" onchange="this.form.submit()">
            </form>
        </div>

        <!-- Right: Details + Forms -->
        <div class="profile-right">
            <div class="detail-box" style="margin-top: 0;">
                <div class="detail">
                    <div class="label">Player ID</div>
                    <div class="value">{{ user[0] }}</div>
                </div>
            </div>

            <div class="detail-box">
                <div class="detail">
                    <div class="label">Email</div>
                    <div class="value">{{ user[2] }}</div>
                </div>
            </div>

            <form action="/profile" method="POST" class="profile-form">
                <div class="input-box">
                    <i class="icon-left">üòä</i>
                    <input type="text" name="name" value="{{ user[1] }}" placeholder="Display name" required>
                </div>
                <button class="auth-btn" type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Stats cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Matches</div>
            <div class="stat-value">{{ user[5] if user[5] else 0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Wins</div>
            <div class="stat-value">{{ user[6] if user[6] else 0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            {% set matches = user[5] if user[5] else 0 %}
            {% set wins = user[6] if user[6] else 0 %}
            {% set win_rate = ((wins / matches * 100) | int) if matches > 0 else 0 %}
            <div class="stat-value">{{ win_rate }}%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total XP</div>
            <div class="stat-value">{{ "{:,}".format(user[7]) if user[7] else 0 }}</div>
        </div>
    </div>
    {% endif %}

    <p style="margin-top:18px;text-align:center">
        <a href="/Dashboard">Back to Dashboard</a>
    </p>
</div>

<script>
    // Set XP progress bar width
    document.addEventListener('DOMContentLoaded', function () {
        const xpBar = document.querySelector('.xp-progress');
        if (xpBar) {
            const progress = xpBar.getAttribute('data-progress');
            xpBar.style.width = progress + '%';
        }
    });
</script>

<style>
    .rank-gold {
        background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    }

    .rank-silver {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8) !important;
    }

    .rank-bronze {
        background: linear-gradient(135deg, #c48f5a, #9b6a38) !important;
    }

    /* Profile header text in purple box */
    .profile-header-text {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 20px;
    }

    .profile-title {
        color: white;
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .profile-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        margin: 8px 0 0 0;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    }

    @media screen and (max-width: 768px) {
        .profile-title {
            font-size: 28px;
        }

        .profile-subtitle {
            font-size: 14px;
        }
    }

    @media screen and (max-width: 480px) {
        .profile-title {
            font-size: 24px;
        }

        .profile-subtitle {
            font-size: 13px;
        }

        .profile-header-text {
            padding: 15px;
        }
    }
</style>

<script>
// Comprehensive back button and swipe prevention
(function() {
    // Replace current history entry
    if (window.history && window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }
    
    // Prevent back navigation
    window.addEventListener('popstate', function(event) {
        window.history.pushState(null, null, window.location.href);
    });
    
    // Push initial state
    window.history.pushState(null, null, window.location.href);
})();

// Prevent page from being cached
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        window.location.reload();
    }
});

// Prevent swipe gestures from navigating back
window.addEventListener('load', function() {
    window.history.pushState(null, null, window.location.href);
});

// Additional protection against back navigation
window.onbeforeunload = function() {
    window.history.pushState(null, null, window.location.href);
};
</script>

{% endblock %}